<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Salt Wash Ward ‚Äì Sunday Worship</title>
<meta name="description" content="Salt Wash Ward Sunday worship services, sacrament program, announcements, and upcoming events. The Church of Jesus Christ of Latter-day Saints in Fruita, Colorado.">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%237c3aed' rx='20' width='100' height='100'/><text x='50' y='68' font-size='48' font-weight='bold' fill='white' text-anchor='middle' font-family='system-ui'>SW</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  color-scheme: light dark;
  font-family: 'Plus Jakarta Sans', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  font-size: 14px;
  --bg: #f9f5ef;
  --bg-alt: #f2e9dd;
  --surface: #ffffff;
  --surface-muted: #fff8f0;
  --surface-soft: rgba(255, 255, 255, 0.82);
  --stroke: rgba(61, 41, 21, 0.12);
  --stroke-strong: rgba(61, 41, 21, 0.18);
  --ink: #2f1c11;
  --ink-soft: rgba(47, 28, 17, 0.78);
  --ink-muted: rgba(47, 28, 17, 0.56);
  --accent: #7c3aed;
  --accent-strong: #5b21b6;
  --accent-soft: rgba(124, 58, 237, 0.18);
  --accent-contrast: #ffffff;
  --warning: #d97706;
  --shadow-lg: 0 28px 60px rgba(64, 41, 102, 0.14);
  --shadow-md: 0 18px 44px rgba(64, 41, 102, 0.12);
  --shadow-sm: 0 10px 28px rgba(64, 41, 102, 0.08);
  --radius-lg: 28px;
  --radius-md: 20px;
  --radius-sm: 14px;
  --transition: 180ms ease;
  --content-width: min(640px, 92vw);
  --header-height: 64px;
}

[data-theme="dark"] {
  --bg: #1b1624;
  --bg-alt: #251d32;
  --surface: rgba(31, 26, 37, 0.92);
  --surface-muted: rgba(44, 34, 58, 0.82);
  --surface-soft: rgba(31, 26, 37, 0.86);
  --stroke: rgba(233, 224, 255, 0.12);
  --stroke-strong: rgba(233, 224, 255, 0.18);
  --ink: #f5f3ff;
  --ink-soft: rgba(245, 243, 255, 0.82);
  --ink-muted: rgba(245, 243, 255, 0.6);
  --accent: #b8a4ff;
  --accent-strong: #9f87ff;
  --accent-soft: rgba(184, 164, 255, 0.22);
  --accent-contrast: #160f24;
  --shadow-lg: 0 32px 70px rgba(10, 6, 18, 0.6);
  --shadow-md: 0 22px 50px rgba(10, 6, 18, 0.48);
  --shadow-sm: 0 14px 32px rgba(10, 6, 18, 0.38);
}

*,
*::before,
*::after {
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  background: radial-gradient(circle at top left, var(--bg-alt), transparent 55%),
    linear-gradient(180deg, var(--bg) 0%, var(--surface) 60%, var(--bg-alt) 100%);
  color: var(--ink);
  font-family: 'Plus Jakarta Sans', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
}

body::before {
  content: "";
  position: fixed;
  inset: 0;
  pointer-events: none;
  background-image: radial-gradient(rgba(124, 58, 237, 0.12) 1px, transparent 1px);
  background-size: 28px 28px;
  opacity: 0.35;
}

[hidden] {
  display: none !important;
}

a {
  color: inherit;
  text-decoration: none;
  transition: color var(--transition), opacity var(--transition);
}

a:hover,
a:focus-visible {
  color: var(--accent-strong);
}

a:focus-visible,
button:focus-visible {
  outline: 3px solid var(--accent);
  outline-offset: 3px;
}

button {
  font: inherit;
  color: inherit;
  background: none;
  border: none;
  cursor: pointer;
}

img {
  max-width: 100%;
  display: block;
}

/* Layout */
.app-shell {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* Header */
.site-header {
  position: sticky;
  top: 2.5rem;
  z-index: 30;
  backdrop-filter: blur(18px);
  background: color-mix(in srgb, var(--surface-soft) 88%, transparent);
  border-bottom: 1px solid var(--stroke);
}

.news-flash[hidden] + .app-shell .site-header {
  top: 0;
}

.header-shell {
  width: var(--content-width);
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.85rem;
  padding: 0.75rem 0;
  min-height: var(--header-height);
  position: relative;
  z-index: 2;
}

/* Brand */
.brand {
  display: inline-flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.55rem 0.85rem 0.55rem 0.55rem;
  border-radius: var(--radius-md);
  border: 1px solid var(--stroke);
  background: var(--surface);
  box-shadow: var(--shadow-sm);
  transition: transform var(--transition), box-shadow var(--transition);
}

.brand:hover {
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

.brand-icon {
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 999px;
  background: linear-gradient(140deg, var(--accent), var(--accent-strong));
  color: var(--accent-contrast);
  display: grid;
  place-items: center;
  font-family: 'Playfair Display', 'Times New Roman', serif;
  font-size: 1.1rem;
  letter-spacing: 0.04em;
}

.brand-copy {
  display: flex;
  flex-direction: column;
  gap: 0.1rem;
}

.brand-title {
  font-family: 'Playfair Display', 'Times New Roman', serif;
  font-size: 1.2rem;
  letter-spacing: 0.02em;
}

.brand-subtitle {
  font-size: 0.82rem;
  color: var(--ink-muted);
}

/* Header Actions */
.header-actions {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  order: 3;
  margin-left: 0.75rem;
}

/* Theme Toggle */
.theme-icon {
  width: 1.25rem;
  height: 1.25rem;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, var(--accent-contrast) 0%, var(--accent-contrast) 34%, transparent 60%),
    linear-gradient(140deg, var(--accent), var(--accent-strong));
  box-shadow: inset 0 -2px 4px rgba(0, 0, 0, 0.16);
}

[data-theme="dark"] .theme-icon {
  background: radial-gradient(circle at 70% 30%, rgba(22, 14, 33, 0.35) 0%, rgba(22, 14, 33, 0.35) 34%, transparent 58%),
    linear-gradient(140deg, var(--accent), var(--accent-strong));
  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.25);
}

.theme-toggle,
.menu-toggle {
  width: 2.75rem;
  height: 2.75rem;
  border-radius: 999px;
  border: 1px solid var(--stroke);
  background: var(--surface);
  display: grid;
  place-items: center;
  transition: transform var(--transition), box-shadow var(--transition);
  box-shadow: var(--shadow-sm);
}

.theme-toggle:hover,
.menu-toggle:hover {
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

/* Menu Toggle */
.menu-toggle {
  position: relative;
}

.menu-toggle::before,
.menu-toggle::after {
  content: '';
  position: absolute;
  width: 18px;
  height: 2px;
  background: var(--ink);
  border-radius: 999px;
  transition: transform var(--transition), opacity var(--transition);
}

.menu-lines {
  display: block;
  position: absolute;
  width: 18px;
  height: 2px;
  background: var(--ink);
  border-radius: 999px;
  transition: transform var(--transition), opacity var(--transition);
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
}

.menu-toggle::before {
  transform: translate(-50%, -6px);
  left: 50%;
  top: 50%;
}

.menu-toggle::after {
  transform: translate(-50%, 6px);
  left: 50%;
  top: 50%;
}

.menu-toggle.open .menu-lines {
  opacity: 0;
}

.menu-toggle.open::before {
  transform: translate(-50%, -50%) rotate(45deg);
}

.menu-toggle.open::after {
  transform: translate(-50%, -50%) rotate(-45deg);
}

/* Navigation */
.primary-nav {
  position: absolute;
  top: calc(100% + 0.75rem);
  right: 1rem;
  width: min(240px, calc(100vw - 2rem));
  background: var(--surface);
  border: 1px solid var(--stroke-strong);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-lg);
  padding: 0.75rem;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-8px);
  transition: opacity var(--transition), transform var(--transition);
  order: 2;
  margin-left: auto;
  z-index: 10;
  pointer-events: none;
}

.primary-nav.open {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
  pointer-events: auto;
}

.nav-list {
  list-style: none;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  align-items: stretch;
}

.nav-link {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.6rem;
  padding: 0.6rem 0.75rem;
  border-radius: var(--radius-sm);
  font-weight: 600;
  color: var(--ink);
  border: 1px solid transparent;
  transition: background var(--transition), color var(--transition), border-color var(--transition);
}

.nav-link:hover,
.nav-link:focus-visible {
  background: var(--accent-soft);
  color: var(--accent-strong);
}

.nav-link.active {
  background: var(--accent-soft);
  border-color: color-mix(in srgb, var(--accent) 40%, transparent);
  color: var(--accent-strong);
}

/* Hero Section */
.hero {
  padding: clamp(1.5rem, 7vw, 2.5rem) 0 1.5rem;
}

.hero-shell {
  width: var(--content-width);
  margin: 0 auto;
}

.hero-card {
  position: relative;
  overflow: hidden;
  border-radius: var(--radius-lg);
  padding: clamp(1.2rem, 4vw, 1.8rem);
  background: linear-gradient(145deg, color-mix(in srgb, var(--surface) 85%, transparent) 0%, var(--surface-muted) 100%);
  box-shadow: var(--shadow-lg);
  border: 1px solid var(--stroke);
}

.hero-card::after {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(circle at 20% 20%, rgba(124, 58, 237, 0.28), transparent 55%),
    radial-gradient(circle at 80% 30%, rgba(124, 58, 237, 0.16), transparent 60%);
  opacity: 0.45;
  pointer-events: none;
}

.hero-card > * {
  position: relative;
  z-index: 1;
}

.hero-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  font-size: 0.76rem;
  text-transform: uppercase;
  letter-spacing: 0.16em;
  font-weight: 700;
  padding: 0.35rem 0.75rem;
  border-radius: 999px;
  background: var(--accent-soft);
  color: var(--accent-strong);
}

.hero-title {
  margin: 0.6rem 0 0.3rem;
  font-family: 'Playfair Display', 'Times New Roman', serif;
  font-size: clamp(1.8rem, 6vw, 2.5rem);
  letter-spacing: 0.01em;
}

.hero-subtitle {
  margin: 0;
  color: var(--ink-soft);
  font-size: 0.98rem;
  max-width: 36ch;
}

.hero-meta {
  margin: 0.8rem 0 1.2rem;
  display: inline-flex;
  align-items: center;
  gap: 0.6rem;
  padding: 0.6rem 0.9rem;
  border-radius: var(--radius-sm);
  background: color-mix(in srgb, var(--surface) 72%, transparent);
  border: 1px solid var(--stroke);
  box-shadow: var(--shadow-sm);
  font-weight: 600;
  color: var(--accent-strong);
}

.hero-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.45rem;
  padding: 0.6rem 1.2rem;
  border-radius: 999px;
  font-weight: 600;
  border: 1px solid transparent;
  transition: transform var(--transition), box-shadow var(--transition), background var(--transition), color var(--transition);
  background: linear-gradient(140deg, var(--accent), var(--accent-strong));
  color: var(--accent-contrast);
  box-shadow: var(--shadow-sm);
}

.btn:hover,
.btn:focus-visible {
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

.btn.ghost {
  background: transparent;
  color: var(--accent-strong);
  border-color: color-mix(in srgb, var(--accent) 35%, transparent);
}

.btn.ghost:hover,
.btn.ghost:focus-visible {
  background: var(--accent-soft);
}

.btn.full {
  width: 100%;
}

/* Sections */
.section {
  padding: clamp(1.5rem, 6vw, 2rem) 0;
}

.section-shell {
  width: var(--content-width);
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.section-header {
  display: flex;
  flex-direction: column;
  gap: 0.4rem;
}

.section-overline {
  font-size: 0.76rem;
  letter-spacing: 0.18em;
  text-transform: uppercase;
  font-weight: 700;
  color: var(--accent-strong);
}

.section-title {
  font-family: 'Playfair Display', 'Times New Roman', serif;
  font-size: clamp(1.6rem, 4.5vw, 2rem);
  margin: 0;
}

.section-intro {
  margin: 0;
  color: var(--ink-soft);
  font-size: 0.95rem;
}

/* Program Grid */
.program-grid {
  display: flex;
  flex-direction: column;
  gap: 0.15rem;
}

.program-card {
  background: var(--surface);
  border: 1px solid var(--stroke);
  border-radius: var(--radius-sm);
  box-shadow: var(--shadow-sm);
  padding: 0.2rem 0.4rem;
  display: grid;
  grid-template-columns: minmax(90px, auto) minmax(0, 1fr);
  column-gap: 0.3rem;
  row-gap: 0.1rem;
  align-items: baseline;
  min-height: 0;
}

.program-title {
  margin: 0;
  font-weight: 600;
  font-size: 0.82rem;
  color: var(--ink);
  line-height: 1.1;
  word-break: break-word;
}

.program-detail {
  margin: 0;
  color: var(--ink-soft);
  font-size: 0.82rem;
  line-height: 1.2;
  word-break: break-word;
}

.program-detail a {
  color: var(--accent-strong);
  text-decoration: underline;
}

.program-grid .error-text {
  margin: 0;
}

@media (max-width: 540px) {
  .program-card {
    grid-template-columns: minmax(80px, auto) minmax(0, 1fr);
    padding: 0.18rem 0.35rem;
    column-gap: 0.3rem;
  }

  .program-title {
    font-size: 0.78rem;
  }

  .program-detail {
    font-size: 0.78rem;
  }
}

/* Announcements */
.announcements-list {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.announcement-card {
  position: relative;
  background: var(--surface);
  border: 1px solid var(--stroke);
  border-radius: var(--radius-md);
  padding: 0.7rem 0.9rem;
  box-shadow: var(--shadow-sm);
  border-left: 4px solid var(--announcement-accent, var(--accent));
  transition: transform var(--transition), box-shadow var(--transition);
}

.announcement-card::after {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: inherit;
  border: 1px solid transparent;
  pointer-events: none;
  background: linear-gradient(120deg, color-mix(in srgb, var(--announcement-accent, var(--accent)) 22%, transparent), transparent 65%);
  opacity: 0;
  transition: opacity var(--transition);
}

.announcement-card:hover,
.announcement-card:focus-within {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.announcement-card:hover::after,
.announcement-card:focus-within::after {
  opacity: 1;
}

.announcement-title {
  margin: 0;
  font-size: 1rem;
  font-weight: 600;
  color: var(--ink);
}

.announcement-body {
  margin: 0.3rem 0 0;
  color: var(--ink-soft);
  font-size: 0.92rem;
}

.announcement-body a {
  color: var(--accent-strong);
  text-decoration: underline;
}

.announcement-link {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  margin-top: 0.4rem;
  font-size: 0.88rem;
  font-weight: 600;
  color: var(--accent-strong);
  letter-spacing: 0.04em;
  text-transform: uppercase;
}

.announcement-link span {
  font-size: 0.95rem;
}

.announcement-link:hover,
.announcement-link:focus-visible {
  color: var(--accent-strong);
  opacity: 0.85;
}

/* Events */
.events-timeline {
  display: flex;
  flex-direction: column;
  gap: 0.6rem;
}

.event-card {
  background: var(--surface);
  border: 1px solid var(--stroke);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-sm);
  padding: 0.7rem 0.9rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  transition: transform var(--transition), box-shadow var(--transition);
}

.event-card:hover,
.event-card:focus-within {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.event-header {
  display: flex;
  flex-direction: column;
  gap: 0.3rem;
}

.event-date {
  font-size: 0.76rem;
  letter-spacing: 0.16em;
  text-transform: uppercase;
  color: var(--ink-muted);
  font-weight: 700;
}

.event-title {
  margin: 0;
  font-size: 1rem;
  font-weight: 600;
}

.event-body {
  color: var(--ink-soft);
  font-size: 0.92rem;
}

.event-body a {
  color: var(--accent-strong);
  text-decoration: underline;
}

.calendar-link {
  align-self: flex-start;
  font-size: 0.76rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  font-weight: 700;
  color: var(--accent-strong);
  padding: 0.4rem 0.8rem;
  border-radius: 999px;
  border: 1px solid color-mix(in srgb, var(--accent) 45%, transparent);
  background: var(--accent-soft);
  transition: background var(--transition), color var(--transition);
}

.calendar-link:hover,
.calendar-link:focus-visible {
  background: var(--accent);
  color: var(--accent-contrast);
}

/* Error Text */
.error-text {
  background: color-mix(in srgb, var(--surface) 72%, var(--warning) 12%);
  border: 1px solid color-mix(in srgb, var(--warning) 45%, transparent);
  border-radius: var(--radius-sm);
  padding: 0.8rem;
  font-weight: 600;
  color: var(--warning);
  text-align: center;
}

/* Footer */
.site-footer {
  margin-top: auto;
  padding: 2rem 1.5rem 2.5rem;
  text-align: center;
  color: var(--ink-muted);
  font-size: 0.88rem;
}

.footer-note {
  margin-top: 0.5rem;
  font-size: 0.82rem;
  color: var(--ink-soft);
  font-style: italic;
}

/* Modal */
.modal {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(16, 10, 27, 0.48);
  backdrop-filter: blur(12px);
  padding: 1rem;
  z-index: 100;
}

.modal-card {
  width: min(420px, 92vw);
  background: var(--surface);
  border-radius: var(--radius-lg);
  border: 1px solid var(--stroke-strong);
  box-shadow: var(--shadow-lg);
  padding: 1.5rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.modal-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 0.8rem;
}

.modal-title {
  margin: 0;
  font-family: 'Playfair Display', 'Times New Roman', serif;
  font-size: 1.5rem;
}

.modal-close {
  width: 2.25rem;
  height: 2.25rem;
  border-radius: 999px;
  border: 1px solid var(--stroke);
  background: var(--surface-muted);
  position: relative;
}

.modal-close::before,
.modal-close::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 12px;
  height: 2px;
  background: var(--ink);
  transform-origin: center;
}

.modal-close::before {
  transform: translate(-50%, -50%) rotate(45deg);
}

.modal-close::after {
  transform: translate(-50%, -50%) rotate(-45deg);
}

.modal-body {
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
  color: var(--ink-soft);
  font-size: 0.92rem;
}

#banner-body > * {
  background: color-mix(in srgb, var(--surface) 85%, var(--accent-soft));
  border-radius: var(--radius-sm);
  padding: 0.7rem 0.9rem;
  border: 1px solid var(--stroke);
}

.modal-body .banner-title {
  font-weight: 600;
  margin-bottom: 0.3rem;
  color: var(--ink);
}

#banner-body strong {
  color: var(--accent-strong);
}

#banner-body a {
  color: var(--accent-strong);
  text-decoration: underline;
}

/* News Flash */
.news-flash {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  background: linear-gradient(90deg, var(--accent), var(--accent-strong));
  color: var(--accent-contrast);
  padding: 0.5rem 2.5rem 0.5rem 1rem;
  z-index: 40;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: var(--shadow-sm);
  overflow: hidden;
}

.news-flash-content {
  white-space: nowrap;
  font-size: 0.9rem;
  font-weight: 600;
  animation: scroll linear infinite;
  display: inline-block;
  padding-right: 5rem;
}

@keyframes scroll {
  0% {
    transform: translateX(100vw);
  }
  100% {
    transform: translateX(-100%);
  }
}

.news-flash-close {
  position: absolute;
  right: 0.5rem;
  top: 50%;
  transform: translateY(-50%);
  width: 1.8rem;
  height: 1.8rem;
  border-radius: 999px;
  background: var(--accent-contrast);
  border: 1px solid var(--stroke);
  display: grid;
  place-items: center;
  transition: transform var(--transition), box-shadow var(--transition);
}

.news-flash-close:hover,
.news-flash-close:focus-visible {
  transform: translateY(-50%) scale(1.05);
  box-shadow: var(--shadow-md);
}

.news-flash-close-icon::before,
.news-flash-close-icon::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 10px;
  height: 2px;
  background: var(--ink);
  transform-origin: center;
}

.news-flash-close-icon::before {
  transform: translate(-50%, -50%) rotate(45deg);
}

.news-flash-close-icon::after {
  transform: translate(-50%, -50%) rotate(-45deg);
}

/* Family Section */
.family-embed {
  width: 100%;
  height: 600px;
  border: 1px solid var(--stroke);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-sm);
}

/* Responsive */
@media (min-width: 640px) {
  .header-shell {
    padding: 0.8rem 0;
  }

  .primary-nav {
    top: calc(100% + 0.8rem);
  }
}

@media (min-width: 768px) {
  .menu-toggle {
    display: none;
  }

  .header-actions {
    margin-left: 0.8rem;
  }

  .primary-nav {
    position: static;
    width: auto;
    padding: 0;
    background: transparent;
    border: none;
    box-shadow: none;
    opacity: 1;
    visibility: visible;
    transform: none;
    pointer-events: auto;
    display: flex;
    align-items: center;
  }

  .nav-list {
    flex-direction: row;
    gap: 0.6rem;
  }

  .nav-link {
    padding: 0.5rem 0.9rem;
    border-radius: 999px;
  }
}

@media (min-width: 880px) {
  .app-shell::after {
    content: '';
    position: fixed;
    right: 6vw;
    top: 18vh;
    width: 220px;
    height: 220px;
    background: radial-gradient(circle, rgba(124, 58, 237, 0.14), transparent 70%);
    pointer-events: none;
    filter: blur(0.5px);
  }

  .section-shell {
    gap: 1.2rem;
  }
}
</style>
</head>
<body>
<div class="news-flash" id="news-flash" role="alert" aria-live="polite" hidden>
  <div class="news-flash-content" id="news-flash-content"></div>
  <button class="news-flash-close" id="news-flash-close" type="button" aria-label="Close news flash">
    <span class="news-flash-close-icon"></span>
  </button>
</div>
<div class="app-shell">
<header class="site-header" aria-label="Primary navigation">
  <div class="header-shell">
    <a class="brand" href="#top">
      <span class="brand-icon" aria-hidden="true">SW</span>
      <span class="brand-copy">
        <span class="brand-title" id="brand-title">Salt Wash Ward</span>
        <span class="brand-subtitle" id="brand-subtitle">Sunday Worship &amp; Community</span>
      </span>
    </a>
    <div class="header-actions">
      <a class="btn ghost" id="zoom-link" href="https://zoom.us/j/98369516446?pwd=MPZm58jx43qv637c5sD21xJG2kW1pe.1" target="_blank" rel="noopener" aria-label="Join our Zoom meeting">Join on Zoom</a>
      <button class="theme-toggle" id="theme-toggle" type="button" aria-label="Switch to light theme" aria-pressed="false">
        <span class="theme-icon" id="theme-icon" aria-hidden="true"></span>
      </button>
      <button class="menu-toggle" id="menu-toggle" type="button" aria-label="Toggle navigation" aria-controls="primary-nav" aria-expanded="false">
        <span class="menu-lines"></span>
      </button>
    </div>
    <nav class="primary-nav" id="primary-nav" aria-label="Section links">
      <ul class="nav-list">
        <li><a class="nav-link" data-scroll="program" href="#program">Program</a></li>
        <li><a class="nav-link" data-scroll="announcements" href="#announcements" hidden>Announcements</a></li>
        <li><a class="nav-link" data-scroll="events" href="#events">Events</a></li>
        <li><a class="nav-link" href="/missionary.html">Missionary</a></li>
        <li><a class="nav-link" data-scroll="family" href="#family" hidden>Family</a></li>
      </ul>
    </nav>
  </div>
</header>
<main id="top">
  <section class="hero" id="hero" aria-labelledby="hero-heading">
    <div class="hero-shell">
      <div class="hero-card">
        <span class="hero-badge">This Sunday</span>
        <h1 class="hero-title" id="hero-heading">Salt Wash Ward</h1>
        <p class="hero-subtitle" id="hero-subtitle"></p>
        <p class="hero-meta" id="hero-meta" role="status" aria-live="polite">üóìÔ∏è Gathering details loading‚Ä¶</p>
        <div class="hero-actions">
          <a class="btn" id="program-scroll" href="#program">Open the program</a>
          <a class="btn ghost" id="events-scroll" href="#events">Ward events</a>
        </div>
      </div>
    </div>
  </section>

  <section class="section" id="program" aria-labelledby="program-heading">
    <div class="section-shell">
      <div class="section-header">
        <span class="section-overline">Sacrament outline</span>
        <h2 class="section-title" id="program-heading">Sunday program</h2>
        <p class="section-intro" id="program-intro"></p>
      </div>
      <div class="program-grid" id="program-grid" role="list"></div>
    </div>
  </section>

  <section class="section" id="announcements" aria-labelledby="announcements-heading" hidden>
    <div class="section-shell">
      <div class="section-header">
        <span class="section-overline">Quick updates</span>
        <h2 class="section-title" id="announcements-heading">Ward announcements</h2>
        <p class="section-intro">Ward reminders.</p>
      </div>
      <div class="announcements-list" id="announcements-list" role="list"></div>
    </div>
  </section>

  <section class="section" id="events" aria-labelledby="events-heading">
    <div class="section-shell">
      <div class="section-header">
        <span class="section-overline">Stay connected</span>
        <h2 class="section-title" id="events-heading">Upcoming events</h2>
        <p class="section-intro">Ward activities, service opportunities, and upcoming events.</p>
      </div>
      <div class="events-timeline" id="events-timeline" role="list"></div>
    </div>
  </section>

  <section class="section" id="family" aria-labelledby="family-heading" hidden>
    <div class="section-shell">
      <div class="section-header">
        <span class="section-overline">Family to Family</span>
        <h2 class="section-title" id="family-heading">Connections & Availability</h2>
        <p class="section-intro">This view refreshes weekly. Submissions may take up to 15 minutes to appear.</p>
      </div>
      <iframe id="family-iframe" class="family-embed" title="Family to Family"></iframe>
    </div>
  </section>
</main>
<footer class="site-footer" aria-label="Site footer">
  <p id="footer-copy">‚ùñ Not an official site of The Church of Jesus Christ of Latter-day Saints. Intended for local Salt Wash Ward use only.</p>
  <p class="footer-note">Designed by members<a href="/admin" style="color: inherit; text-decoration: none;">.</a></p>
</footer>
</div>

<div class="modal" id="banner-modal" role="dialog" aria-modal="true" aria-labelledby="banner-title" aria-describedby="banner-body" hidden>
  <div class="modal-card">
    <div class="modal-header">
      <h2 class="modal-title" id="banner-title">Announcements</h2>
      <button class="modal-close" id="modal-close" type="button" aria-label="Close banner"></button>
    </div>
    <div class="modal-body" id="banner-body"></div>
    <button class="btn full" id="modal-dismiss" type="button">Got it!</button>
  </div>
</div>

<script type="module">
// Firebase SDK imports
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyBYkgD6v0mAFfCDEm_X1lbPR7kh3H27ukg",
  authDomain: "salt-wash-ward-missionary.firebaseapp.com",
  databaseURL: "https://salt-wash-ward-missionary-default-rtdb.firebaseio.com",
  projectId: "salt-wash-ward-missionary",
  storageBucket: "salt-wash-ward-missionary.firebasestorage.app",
  messagingSenderId: "655176347538",
  appId: "1:655176347538:web:fe919cb904eba9eb151b4b"
};

// Initialize Firebase
const firebaseApp = initializeApp(firebaseConfig);
const db = getDatabase(firebaseApp);

// === Configuration ===
const CONFIG = {
  WARD_INFO_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQmevhTdTKYKv7TPUhyjWqykITrkza17Wd4fLarNw4Bi_dRDPEW3cXkWWLx8GwUOZLS39LgziZCxffQ/pub?gid=1717567915&single=true&output=csv',
  PROGRAM_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQmevhTdTKYKv7TPUhyjWqykITrkza17Wd4fLarNw4Bi_dRDPEW3cXkWWLx8GwUOZLS39LgziZCxffQ/pub?gid=349175455&single=true&output=csv',
  EVENTS_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQmevhTdTKYKv7TPUhyjWqykITrkza17Wd4fLarNw4Bi_dRDPEW3cXkWWLx8GwUOZLS39LgziZCxffQ/pub?gid=321660920&single=true&output=csv',
  FAMILY_IFRAME: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQmevhTdTKYKv7TPUhyjWqykITrkza17Wd4fLarNw4Bi_dRDPEW3cXkWWLx8GwUOZLS39LgziZCxffQ/pubhtml?gid=345393097&single=true&widget=true&headers=false',
  CORS_PROXY: 'https://api.allorigins.win/raw?url=',
  USE_FIREBASE_PROGRAM: true  // Set to true to use Firebase, false for Google Sheets
};

// === State ===
const state = {
  debugBanner: false,
  bannerSeenKey: 'salt-wash-ward-banner-seen',
  wardDetails: null,
  lastFocusedElement: null
};

// === DOM Selectors ===
const SELECTORS = {
  brandTitle: document.getElementById('brand-title'),
  brandSubtitle: document.getElementById('brand-subtitle'),
  heroTitle: document.getElementById('hero-heading'),
  heroSubtitle: document.getElementById('hero-subtitle'),
  heroMeta: document.getElementById('hero-meta'),
  programIntro: document.getElementById('program-intro'),
  programGrid: document.getElementById('program-grid'),
  announcementsSection: document.getElementById('announcements'),
  announcementsList: document.getElementById('announcements-list'),
  eventsTimeline: document.getElementById('events-timeline'),
  eventsSection: document.getElementById('events'),
  footerCopy: document.getElementById('footer-copy'),
  navLinks: Array.from(document.querySelectorAll('.nav-link[data-scroll]')),
  modal: document.getElementById('banner-modal'),
  modalTitle: document.getElementById('banner-title'),
  modalBody: document.getElementById('banner-body'),
  modalDismiss: document.getElementById('modal-dismiss'),
  modalClose: document.getElementById('modal-close'),
  themeToggle: document.getElementById('theme-toggle'),
  menuToggle: document.getElementById('menu-toggle'),
  nav: document.getElementById('primary-nav'),
  eventsNavLink: document.querySelector('[data-scroll="events"]'),
  announcementsNavLink: document.querySelector('[data-scroll="announcements"]'),
  familySection: document.getElementById('family'),
  familyNavLink: document.querySelector('[data-scroll="family"]'),
  familyIframe: document.getElementById('family-iframe'),
  newsFlash: document.getElementById('news-flash'),
  newsFlashContent: document.getElementById('news-flash-content'),
  newsFlashClose: document.getElementById('news-flash-close')
};

// === Utility Functions ===
state.debugBanner = new URLSearchParams(window.location.search).get('banner') === 'debug' || state.debugBanner;

/**
 * Sanitizes text by escaping HTML entities and converting newlines to <br>
 */
function sanitize(text = '') {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML.replace(/\n/g, '<br>');
}

/**
 * Displays an inline error message in the specified container
 */
function showInlineError(container, message) {
  if (!container) return;
  container.innerHTML = `<p class="error-text">${message}</p>`;
}

/**
 * Fetches a URL with fallback to CORS proxy
 */
async function fetchWithFallback(url) {
  try {
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`Fetch failed: ${response.status} ${response.statusText}`);
    }
    return response;
  } catch (error) {
    console.warn(`Direct fetch failed for ${url}. Retrying with proxy`, error);
    try {
      const proxyResponse = await fetch(`${CONFIG.CORS_PROXY}${encodeURIComponent(url)}`);
      if (!proxyResponse.ok) {
        throw new Error(`Proxy fetch failed: ${proxyResponse.status} ${proxyResponse.statusText}`);
      }
      return proxyResponse;
    } catch (proxyError) {
      console.error(`Unable to retrieve ${url}`, proxyError);
      throw new Error('We were unable to load the latest information. Please try again soon.');
    }
  }
}

/**
 * Parses CSV text into a 2D array
 */
function parseCSV(text) {
  if (!text || typeof text !== 'string') {
    throw new Error('Invalid CSV payload');
  }
  if (text.trim().startsWith('<!DOCTYPE html>')) {
    throw new Error('Google Sheet returned HTML instead of CSV. Ensure it is published as CSV.');
  }

  const rows = [];
  let cell = '';
  let row = [];
  let inQuotes = false;

  const commitCell = () => {
    row.push(cell.trim());
    cell = '';
  };

  const commitRow = () => {
    if (row.length && row.some(Boolean)) {
      rows.push(row);
    }
    row = [];
  };

  for (let i = 0; i < text.length; i++) {
    const char = text[i];
    if (char === '"') {
      const next = text[i + 1];
      if (inQuotes && next === '"') {
        cell += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
    } else if (char === ',' && !inQuotes) {
      commitCell();
    } else if (!inQuotes && (char === '\n' || char === '\r')) {
      commitCell();
      commitRow();
      if (char === '\r' && text[i + 1] === '\n') {
        i++;
      }
    } else {
      cell += char;
    }
  }

  if (cell.length || row.length) {
    commitCell();
    commitRow();
  }

  return rows;
}

// === Date/Calendar Functions ===
function formatDateForCalendar(date) {
  const pad = (value) => String(value).padStart(2, '0');
  return [
    date.getUTCFullYear(),
    pad(date.getUTCMonth() + 1),
    pad(date.getUTCDate())
  ].join('') + 'T' + [
    pad(date.getUTCHours()),
    pad(date.getUTCMinutes()),
    pad(date.getUTCSeconds())
  ].join('') + 'Z';
}

function hasDateOrDay(value = '') {
  const text = value.toLowerCase();
  return /(sunday|monday|tuesday|wednesday|thursday|friday|saturday|every\s+\w+)/i.test(text) ||
    /(january|february|march|april|may|june|july|august|september|october|november|december)/i.test(text) ||
    /\d{1,2}(st|nd|rd|th)/i.test(text);
}

function parseEventDate(dateText = '', info = '') {
  const now = new Date();
  const currentYear = now.getFullYear();
  let eventDate = new Date(now);
  const text = `${dateText} ${info}`.trim();

  if (text.toLowerCase().includes('every ')) {
    const day = text.toLowerCase().match(/every\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday)/);
    if (day) {
      const dayIndex = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'].indexOf(day[1]);
      eventDate = new Date(now);
      while (eventDate.getDay() !== dayIndex) {
        eventDate.setDate(eventDate.getDate() + 1);
      }
    }
  } else {
    const monthMatch = text.match(/(january|february|march|april|may|june|july|august|september|october|november|december)\s+\d{1,2}/i);
    if (monthMatch) {
      eventDate = new Date(`${monthMatch[0]}, ${currentYear}`);
      if (!Number.isFinite(eventDate.valueOf())) {
        eventDate = new Date(now);
      }
      if (eventDate < now) {
        eventDate.setFullYear(currentYear + 1);
      }
    }
  }

  const parseTimeString = (input) => {
    if (!input) return null;
    const match = input.trim().match(/(\d{1,2})(?::(\d{2}))?\s*(am|pm)?/i);
    if (!match) return null;
    let hours = parseInt(match[1], 10);
    const minutes = parseInt(match[2] ?? '0', 10);
    const period = match[3]?.toLowerCase();
    if (period === 'pm' && hours < 12) hours += 12;
    if (period === 'am' && hours === 12) hours = 0;
    if (!period && hours === 24) hours = 0;
    return { hours, minutes };
  };

  const rangeMatch = text.match(/(\d{1,2}(?::\d{2})?\s*(?:am|pm)?)\s*[-‚Äì]\s*(\d{1,2}(?::\d{2})?\s*(?:am|pm)?)/i);
  let startTime = parseTimeString(rangeMatch ? rangeMatch[1] : text);
  let endTime = rangeMatch ? parseTimeString(rangeMatch[2]) : null;

  if (!startTime) {
    startTime = { hours: 9, minutes: 0 };
  }

  eventDate.setHours(startTime.hours, startTime.minutes, 0, 0);
  const endDate = new Date(eventDate);

  if (endTime) {
    endDate.setHours(endTime.hours, endTime.minutes, 0, 0);
  } else {
    endDate.setHours(endDate.getHours() + 1);
  }

  return { start: eventDate, end: endDate };
}

function createCalendarLink({ title, description, start, end, location }) {
  const params = new URLSearchParams({
    action: 'TEMPLATE',
    text: title,
    dates: `${formatDateForCalendar(start)}/${formatDateForCalendar(end)}`,
    details: description
  });
  if (location) params.set('location', location);
  return `https://www.google.com/calendar/render?${params.toString()}`;
}

function getCurrentSunday() {
  const today = new Date();
  const sunday = new Date(today);
  sunday.setDate(today.getDate() - today.getDay());
  return sunday.toLocaleDateString('en-US', {
    month: 'long',
    day: 'numeric',
    year: 'numeric'
  });
}

// === Navigation Functions ===
function updateNavState(id) {
  SELECTORS.navLinks.forEach((link) => {
    link.classList.toggle('active', link.dataset.scroll === id);
  });
}

function smoothScrollTo(targetId) {
  const element = document.getElementById(targetId);
  if (!element) return;
  element.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function initNavigation() {
  const setMenuState = (isOpen) => {
    if (!SELECTORS.menuToggle || !SELECTORS.nav) return;
    SELECTORS.menuToggle.classList.toggle('open', isOpen);
    SELECTORS.nav.classList.toggle('open', isOpen);
    SELECTORS.menuToggle.setAttribute('aria-expanded', String(isOpen));
  };

  setMenuState(false);

  SELECTORS.navLinks.forEach((link) => {
    link.addEventListener('click', (event) => {
      event.preventDefault();
      const { scroll } = event.currentTarget.dataset;
      updateNavState(scroll);
      smoothScrollTo(scroll);
      setMenuState(false);
    });
  });

  [
    ['program-scroll', 'program'],
    ['events-scroll', 'events']
  ].forEach(([id, target]) => {
    const trigger = document.getElementById(id);
    if (trigger) {
      trigger.addEventListener('click', (event) => {
        event.preventDefault();
        updateNavState(target);
        smoothScrollTo(target);
      });
    }
  });

  SELECTORS.menuToggle?.addEventListener('click', () => {
    const isOpen = !SELECTORS.menuToggle.classList.contains('open');
    setMenuState(isOpen);
  });

  window.addEventListener('keydown', (event) => {
    if (event.key === 'Escape') {
      setMenuState(false);
    }
  });

  const sections = SELECTORS.navLinks
    .map((link) => document.getElementById(link.dataset.scroll))
    .filter(Boolean);

  if (sections.length) {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          updateNavState(entry.target.id);
        }
      });
    }, { threshold: 0.55 });
    sections.forEach((section) => observer.observe(section));
  }
}

// === Theme Functions ===
function applyTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  document.body.dataset.theme = theme;

  if (SELECTORS.themeToggle) {
    const isDark = theme === 'dark';
    const next = isDark ? 'light' : 'dark';
    SELECTORS.themeToggle.setAttribute('aria-label', `Switch to ${next} theme`);
    SELECTORS.themeToggle.setAttribute('aria-pressed', isDark ? 'true' : 'false');
  }
}

function initTheme() {
  const stored = localStorage.getItem('theme');
  const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
  const initial = stored === 'light' || stored === 'dark' ? stored : (prefersLight ? 'light' : 'dark');

  applyTheme(initial);

  SELECTORS.themeToggle?.addEventListener('click', () => {
    const current = document.documentElement.getAttribute('data-theme') || 'dark';
    const next = current === 'light' ? 'dark' : 'light';
    applyTheme(next);
    localStorage.setItem('theme', next);
  });
}

// === Modal Functions ===
function initModal() {
  if (SELECTORS.modal) {
    SELECTORS.modal.setAttribute('aria-hidden', 'true');
  }

  const closeModal = () => {
    if (!SELECTORS.modal) return;
    SELECTORS.modal.setAttribute('hidden', '');
    SELECTORS.modal.setAttribute('aria-hidden', 'true');
    document.body.style.removeProperty('overflow');
    if (state.lastFocusedElement instanceof HTMLElement) {
      state.lastFocusedElement.focus();
    }
    state.lastFocusedElement = null;
  };

  const trapFocus = (event) => {
    if (event.key !== 'Tab' || !SELECTORS.modal || SELECTORS.modal.hasAttribute('hidden')) return;

    const focusable = SELECTORS.modal.querySelectorAll(
      'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])'
    );
    if (!focusable.length) return;

    const first = focusable[0];
    const last = focusable[focusable.length - 1];

    if (event.shiftKey && document.activeElement === first) {
      event.preventDefault();
      last.focus();
    } else if (!event.shiftKey && document.activeElement === last) {
      event.preventDefault();
      first.focus();
    }
  };

  SELECTORS.modalDismiss?.addEventListener('click', closeModal);
  SELECTORS.modalClose?.addEventListener('click', closeModal);
  SELECTORS.modal?.addEventListener('click', (event) => {
    if (event.target === SELECTORS.modal) closeModal();
  });
  SELECTORS.modal?.addEventListener('keydown', trapFocus);
  window.addEventListener('keydown', (event) => {
    if (event.key === 'Escape') closeModal();
  });
}

// === Banner Functions ===
function shouldShowBanner() {
  if (state.debugBanner) return true;
  const lastShown = localStorage.getItem(state.bannerSeenKey);
  if (!lastShown) return true;
  const lastDate = new Date(parseInt(lastShown, 10));
  const today = new Date();
  return lastDate.toDateString() !== today.toDateString();
}

function renderBanner({ title, announcements }) {
  if (!SELECTORS.modal || !Array.isArray(announcements) || !announcements.length) return;
  if (!shouldShowBanner()) return;

  SELECTORS.modalTitle.textContent = title || 'Announcements';
  SELECTORS.modalBody.innerHTML = '';

  announcements.forEach((item) => {
    const row = document.createElement('div');
    row.className = 'banner-row';
    if (item.accent) {
      row.style.borderColor = item.accent;
    }

    const heading = document.createElement('div');
    heading.className = 'banner-title';
    heading.textContent = item.title;
    if (item.accent) {
      heading.style.color = item.accent;
    }

    const copy = document.createElement('div');
    copy.innerHTML = item.link
      ? `<a href="${item.link}" target="_blank" rel="noopener">${item.description}</a>`
      : item.description;

    row.append(heading, copy);
    SELECTORS.modalBody.appendChild(row);
  });

  state.lastFocusedElement = document.activeElement instanceof HTMLElement ? document.activeElement : null;
  SELECTORS.modal.removeAttribute('hidden');
  SELECTORS.modal.setAttribute('aria-hidden', 'false');
  document.body.style.setProperty('overflow', 'hidden');

  requestAnimationFrame(() => {
    SELECTORS.modalDismiss?.focus();
  });

  if (!state.debugBanner) {
    localStorage.setItem(state.bannerSeenKey, Date.now().toString());
  }
}

function renderNewsFlash({ announcements }) {
  if (!SELECTORS.newsFlash || !SELECTORS.newsFlashContent || !Array.isArray(announcements) || !announcements.length) return;
  if (state.wardDetails?.hideBanner) return;

  SELECTORS.newsFlashContent.innerHTML = '';
  const defaultColors = ['#ffffff', '#f0f0f0', '#e0e0e0', '#d0d0d0'];

  const content = announcements.map((item, index) => {
    const titleText = item.title || 'Announcement';
    const descriptionText = item.description || '';
    const linkText = item.link
      ? `<a href="${item.link}" target="_blank" rel="noopener">${descriptionText}</a>`
      : descriptionText;
    const color = item.accent || defaultColors[index % defaultColors.length];
    return `<span style="color: ${color}; padding-right: 3rem;">${titleText}: ${linkText}</span>`;
  }).join(' ‚Ä¢‚Ä¢‚Ä¢ ');

  SELECTORS.newsFlashContent.innerHTML = content;
  SELECTORS.newsFlash.removeAttribute('hidden');
  SELECTORS.newsFlash.setAttribute('aria-hidden', 'false');

  const contentWidth = SELECTORS.newsFlashContent.offsetWidth;
  const windowWidth = window.innerWidth;
  const scrollDuration = Math.max(10, (contentWidth / windowWidth) * 15);
  SELECTORS.newsFlashContent.style.animationDuration = `${scrollDuration}s`;

  const autoDismiss = setTimeout(() => {
    closeNewsFlash();
  }, scrollDuration * 1000);

  function closeNewsFlash() {
    SELECTORS.newsFlash.setAttribute('hidden', '');
    SELECTORS.newsFlash.setAttribute('aria-hidden', 'true');
  }

  SELECTORS.newsFlashClose?.addEventListener('click', () => {
    clearTimeout(autoDismiss);
    closeNewsFlash();
  }, { once: true });
}

// === Ward Info Functions ===
function updateWardDom({
  wardName,
  subtitle,
  location,
  sacramentStart,
  hideEvents,
  hideBanner,
  showFamily
}) {
  document.title = `${wardName} ‚Äì ${subtitle || 'Sunday Worship Service'}`;

  if (SELECTORS.brandTitle) SELECTORS.brandTitle.textContent = wardName;
  if (SELECTORS.brandSubtitle) SELECTORS.brandSubtitle.textContent = subtitle || 'Sunday Worship & Community';
  if (SELECTORS.heroTitle) SELECTORS.heroTitle.textContent = `${wardName} Sunday Services`;
  if (SELECTORS.heroSubtitle) SELECTORS.heroSubtitle.textContent = subtitle || 'Sunday Worship Service';
  if (SELECTORS.heroMeta) {
    SELECTORS.heroMeta.textContent = `üóìÔ∏è ${getCurrentSunday()} ‚õ™ ${location} ‚è∞ ${sacramentStart}`;
  }
  if (SELECTORS.programIntro) SELECTORS.programIntro.textContent = 'A quick look';
  if (SELECTORS.footerCopy) {
    SELECTORS.footerCopy.textContent = `‚ùñ Not an official site of The Church of Jesus Christ of Latter-day Saints. Intended for local ${wardName} use only.`;
  }

  // Events toggle
  if (hideEvents) {
    SELECTORS.eventsSection?.setAttribute('hidden', '');
    SELECTORS.eventsNavLink?.setAttribute('hidden', '');
  } else {
    SELECTORS.eventsSection?.removeAttribute('hidden');
    SELECTORS.eventsNavLink?.removeAttribute('hidden');
  }

  // Banner toggle
  if (hideBanner && SELECTORS.modal) {
    SELECTORS.modal.setAttribute('hidden', '');
    SELECTORS.modal.setAttribute('aria-hidden', 'true');
  }

  // Family section toggle
  if (showFamily) {
    SELECTORS.familySection?.removeAttribute('hidden');
    SELECTORS.familyNavLink?.removeAttribute('hidden');
    if (SELECTORS.familyIframe) {
      SELECTORS.familyIframe.src = CONFIG.FAMILY_IFRAME;
    }
  } else {
    SELECTORS.familySection?.setAttribute('hidden', '');
    SELECTORS.familyNavLink?.setAttribute('hidden', '');
  }

  return { wardName, subtitle, location, sacramentStart, hideEvents, hideBanner, showFamily };
}

async function loadWardInfo() {
  try {
    const response = await fetchWithFallback(CONFIG.WARD_INFO_URL);
    const rows = parseCSV(await response.text());

    if (!rows.length) {
      throw new Error('Ward info sheet is empty');
    }

    const wardInfo = {};
    rows.forEach((row) => {
      for (let i = 0; i < row.length; i++) {
        const key = row[i]?.trim().toLowerCase();
        if (!key) continue;
        const value = row[i + 1]?.trim();
        if (value) {
          wardInfo[key] = value;
        }
      }
    });

    const details = {
      wardName: wardInfo['ward name'] ?? 'Salt Wash Ward',
      subtitle: wardInfo['subtitle'] ?? 'Sunday Worship Service',
      location: wardInfo['location'] ?? 'Fruita, Colorado',
      sacramentStart: wardInfo['sacrament start time'] ?? '9:00 AM',
      hideEvents: (wardInfo['upcoming events'] || wardInfo['events'] || '').toUpperCase() === 'YES',
      hideBanner: (wardInfo['pop up banner'] || '').toUpperCase() === 'YES',
      showFamily: (wardInfo['family to family'] || '').toUpperCase() !== 'YES'
    };

    state.wardDetails = updateWardDom(details);
    return state.wardDetails;
  } catch (error) {
    console.error('Ward info failed to load', error);
    const fallback = {
      wardName: 'Salt Wash Ward',
      subtitle: 'Sunday Worship Service',
      location: 'Fruita, Colorado',
      sacramentStart: '9:00 AM',
      hideEvents: false,
      hideBanner: false,
      showFamily: true
    };
    state.wardDetails = updateWardDom(fallback);
    return state.wardDetails;
  }
}

// === Announcements Functions ===
function renderAnnouncements(items = []) {
  const { announcementsSection, announcementsList, announcementsNavLink } = SELECTORS;
  if (!announcementsSection || !announcementsList) return;

  announcementsList.innerHTML = '';

  if (!items || !items.length) {
    announcementsSection.setAttribute('hidden', '');
    announcementsSection.setAttribute('aria-hidden', 'true');
    announcementsNavLink?.setAttribute('hidden', '');
    return;
  }

  announcementsSection.removeAttribute('hidden');
  announcementsSection.setAttribute('aria-hidden', 'false');
  announcementsNavLink?.removeAttribute('hidden');

  items.forEach((item, index) => {
    const card = document.createElement('article');
    card.className = 'announcement-card';
    card.setAttribute('role', 'listitem');
    card.style.animationDelay = `${index * 70}ms`;

    if (item.accent) {
      card.style.setProperty('--announcement-accent', item.accent);
    } else {
      card.style.removeProperty('--announcement-accent');
    }

    const title = document.createElement('h3');
    title.className = 'announcement-title';
    title.textContent = item.title || 'Announcement';
    card.appendChild(title);

    if (item.description) {
      const body = document.createElement('p');
      body.className = 'announcement-body';
      body.innerHTML = sanitize(item.description);
      card.appendChild(body);
    }

    if (item.link && item.link.startsWith('http')) {
      const link = document.createElement('a');
      link.className = 'announcement-link';
      link.href = item.link;
      link.target = '_blank';
      link.rel = 'noopener';
      link.setAttribute('aria-label', `Open details for ${item.title || 'announcement'}`);
      link.innerHTML = 'Open details <span aria-hidden="true">‚Üó</span>';
      card.appendChild(link);
    }

    announcementsList.appendChild(card);
  });
}

// === Program Functions ===
function renderProgram(rows) {
  if (!SELECTORS.programGrid) return;
  SELECTORS.programGrid.innerHTML = '';

  const cards = [];
  let bannerTitle = 'Announcements';
  const bannerItems = [];
  const announcementItems = [];

  for (let i = 0; i < rows.length; i++) {
    const [program = '', details = '', link = '', accent = ''] = rows[i];

    if (!program.trim()) continue;

    if (program.startsWith('#SECTION:')) {
      const sectionName = program.replace('#SECTION:', '').trim().toLowerCase();

      if (sectionName === 'banner') {
        bannerTitle = details || bannerTitle;
        let j = i + 1;
        while (rows[j] && !rows[j][0]?.startsWith('#SECTION:')) {
          const [title, description, url, color] = rows[j];
          bannerItems.push({
            title: (title || 'Announcement').trim(),
            description: (description || '').trim(),
            link: (url || '').trim(),
            accent: (color || accent || '').trim()
          });
          j++;
        }
        i = j - 1;
      } else if (sectionName === 'announcements') {
        let j = i + 1;
        while (rows[j] && !rows[j][0]?.startsWith('#SECTION:')) {
          const [title, description, url, color] = rows[j];
          const rawTitle = (title || '').trim();
          const trimmedDescription = (description || '').trim();
          const trimmedLink = (url || '').trim();
          const trimmedAccent = (color || accent || '').trim();

          if (!rawTitle && !trimmedDescription && !trimmedLink) {
            j++;
            continue;
          }

          announcementItems.push({
            title: rawTitle || 'Announcement',
            description: trimmedDescription,
            link: trimmedLink,
            accent: trimmedAccent
          });
          j++;
        }
        i = j - 1;
      } else if (sectionName === 'testimony') {
        // Add testimony meeting card
        const testimonyCard = document.createElement('article');
        testimonyCard.className = 'program-card testimony-card';
        testimonyCard.setAttribute('role', 'listitem');

        const testimonyHeading = document.createElement('p');
        testimonyHeading.className = 'program-title';
        testimonyHeading.textContent = 'Fast & Testimony Meeting';

        const testimonyDetail = document.createElement('p');
        testimonyDetail.className = 'program-detail';
        testimonyDetail.textContent = details.trim() || 'Members of the congregation are invited to share their testimonies.';

        testimonyCard.append(testimonyHeading, testimonyDetail);
        cards.push(testimonyCard);
      }
      continue;
    }

    if (!details.trim()) continue;

    const card = document.createElement('article');
    card.className = 'program-card';
    card.setAttribute('role', 'listitem');

    const heading = document.createElement('p');
    heading.className = 'program-title';
    heading.textContent = program.trim();

    const description = document.createElement('p');
    description.className = 'program-detail';
    const trimmedLink = link.trim();
    const html = trimmedLink.startsWith('http')
      ? `<a href="${trimmedLink}" target="_blank" rel="noopener">${sanitize(details)}</a>`
      : sanitize(details);
    description.innerHTML = html;

    card.append(heading, description);
    cards.push(card);
  }

  if (!cards.length) {
    const empty = document.createElement('p');
    empty.className = 'error-text';
    empty.textContent = 'Program information will be available shortly.';
    SELECTORS.programGrid.appendChild(empty);
  } else {
    cards.forEach((card, index) => {
      card.style.animationDelay = `${index * 70}ms`;
      SELECTORS.programGrid.appendChild(card);
    });
  }

  renderAnnouncements(announcementItems);

  if (!state.wardDetails?.hideBanner && bannerItems.length) {
    renderBanner({ title: bannerTitle, announcements: bannerItems });
    renderNewsFlash({ announcements: bannerItems });
  }
}

async function loadProgram() {
  try {
    let rows;

    if (CONFIG.USE_FIREBASE_PROGRAM) {
      // Load from Firebase
      const snapshot = await get(ref(db, 'sundayProgram'));
      if (snapshot.exists()) {
        const data = snapshot.val();
        // Convert Firebase format to rows format
        rows = data.map(item => [
          item.program || '',
          item.details || '',
          item.link || '',
          item.accent || ''
        ]);
      } else {
        throw new Error('No program data in Firebase');
      }
    } else {
      // Load from Google Sheets (fallback)
      const response = await fetchWithFallback(CONFIG.PROGRAM_URL);
      rows = parseCSV(await response.text());

      if (!rows.length) {
        throw new Error('Program sheet is empty');
      }

      if (rows[0][0]?.toLowerCase().includes('program')) {
        rows.shift();
      }
    }

    renderProgram(rows);
  } catch (error) {
    console.error('Program failed to load', error);
    showInlineError(SELECTORS.programGrid, 'We could not load today\'s program. Please refresh or try again soon.');
    renderAnnouncements([]);
  }
}

// === Events Functions ===
function renderEvents(rows) {
  if (!SELECTORS.eventsTimeline) return;
  SELECTORS.eventsTimeline.innerHTML = '';

  if (!rows.length) {
    showInlineError(SELECTORS.eventsTimeline, 'No upcoming events were found. Check back soon!');
    return;
  }

  rows.forEach(([dateRaw = '', titleRaw = '', infoRaw = '', typeRaw = '', urlRaw = '']) => {
    const info = infoRaw.trim();
    if (!info && !titleRaw.trim()) return;

    const date = dateRaw.trim();
    const title = titleRaw.trim();
    const eventType = typeRaw.trim();
    const link = urlRaw.trim();

    // Pick icon based on event type
    const icon = eventType === 'one-time' ? 'üìå' : 'üîÑ';

    const card = document.createElement('article');
    card.className = 'event-card';

    const header = document.createElement('div');
    header.className = 'event-header';

    const dateLabel = document.createElement('span');
    dateLabel.className = 'event-date';
    dateLabel.textContent = date || 'Date TBD';

    const name = document.createElement('h3');
    name.className = 'event-title';
    name.textContent = `${icon} ${title || 'Ward Event'}`;

    header.append(dateLabel, name);

    const body = document.createElement('div');
    body.className = 'event-body';
    body.innerHTML = link.startsWith('http')
      ? `<a href="${link}" target="_blank" rel="noopener">${info}</a>`
      : info;

    card.append(header, body);

    if (hasDateOrDay(date) || hasDateOrDay(info)) {
      const { start, end } = parseEventDate(date, infoRaw);
      const calendarLink = document.createElement('a');
      calendarLink.href = createCalendarLink({
        title: title || 'Ward Event',
        description: info,
        start,
        end,
        location: state.wardDetails?.location
      });
      calendarLink.target = '_blank';
      calendarLink.rel = 'noopener';
      calendarLink.className = 'calendar-link';
      calendarLink.textContent = 'Add to calendar';
      card.appendChild(calendarLink);
    }

    SELECTORS.eventsTimeline.appendChild(card);
  });
}

async function loadEvents() {
  if (SELECTORS.eventsSection?.hasAttribute('hidden')) return;

  try {
    let rows;

    if (CONFIG.USE_FIREBASE_PROGRAM) {
      // Load from Firebase
      const snapshot = await get(ref(db, 'events'));
      if (snapshot.exists()) {
        const data = snapshot.val();
        const now = new Date();

        // Convert Firebase format to rows format: [date, title, info, type, link]
        // Also filter out expired one-time events
        rows = data
          .filter(item => {
            if (item.type === 'one-time' && item.date) {
              const eventDate = new Date(item.date);
              if (!isNaN(eventDate.getTime())) {
                const endOfEventDay = new Date(eventDate);
                endOfEventDay.setDate(endOfEventDay.getDate() + 1);
                return endOfEventDay >= now;
              }
            }
            return true;
          })
          .map(item => [
            item.date || '',
            item.title || '',
            item.info || '',
            item.type || 'recurring',
            item.link || ''
          ]);
      } else {
        rows = [];
      }
    } else {
      // Load from Google Sheets (fallback)
      const response = await fetchWithFallback(CONFIG.EVENTS_URL);
      rows = parseCSV(await response.text());

      if (rows[0]?.[0]?.toLowerCase().includes('date')) {
        rows.shift();
      }
    }

    renderEvents(rows);
  } catch (error) {
    console.error('Events failed to load', error);
    showInlineError(SELECTORS.eventsTimeline, 'Upcoming events are unavailable right now.');
  }
}

// === Initialization ===
async function init() {
  initTheme();
  initNavigation();
  initModal();

  await loadWardInfo();

  const results = await Promise.allSettled([
    loadProgram(),
    loadEvents()
  ]);

  results.forEach((result) => {
    if (result.status === 'rejected') {
      console.error(result.reason);
    }
  });
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
