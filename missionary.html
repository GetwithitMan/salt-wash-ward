<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Missionary Dinner Calendar â€“ Salt Wash Ward</title>
<meta name="description" content="Sign up to feed the missionaries in the Salt Wash Ward. View available dates and register your family for dinner.">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%237c3aed' rx='20' width='100' height='100'/><text x='50' y='68' font-size='48' font-weight='bold' fill='white' text-anchor='middle' font-family='system-ui'>SW</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  color-scheme: light dark;
  font-family: 'Plus Jakarta Sans', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  font-size: 14px;
  --bg: #f9f5ef;
  --bg-alt: #f2e9dd;
  --surface: #ffffff;
  --surface-muted: #fff8f0;
  --surface-soft: rgba(255, 255, 255, 0.82);
  --stroke: rgba(61, 41, 21, 0.12);
  --stroke-strong: rgba(61, 41, 21, 0.18);
  --ink: #2f1c11;
  --ink-soft: rgba(47, 28, 17, 0.78);
  --ink-muted: rgba(47, 28, 17, 0.56);
  --accent: #7c3aed;
  --accent-strong: #5b21b6;
  --accent-soft: rgba(124, 58, 237, 0.18);
  --accent-contrast: #ffffff;
  --success: #10b981;
  --success-soft: rgba(16, 185, 129, 0.18);
  --warning: #d97706;
  --danger: #ef4444;
  --danger-soft: rgba(239, 68, 68, 0.18);
  --shadow-lg: 0 28px 60px rgba(64, 41, 102, 0.14);
  --shadow-md: 0 18px 44px rgba(64, 41, 102, 0.12);
  --shadow-sm: 0 10px 28px rgba(64, 41, 102, 0.08);
  --radius-lg: 28px;
  --radius-md: 20px;
  --radius-sm: 14px;
  --transition: 180ms ease;
  --content-width: min(900px, 94vw);
  --header-height: 64px;
}

[data-theme="dark"] {
  --bg: #1b1624;
  --bg-alt: #251d32;
  --surface: rgba(31, 26, 37, 0.92);
  --surface-muted: rgba(44, 34, 58, 0.82);
  --surface-soft: rgba(31, 26, 37, 0.86);
  --stroke: rgba(233, 224, 255, 0.12);
  --stroke-strong: rgba(233, 224, 255, 0.18);
  --ink: #f5f3ff;
  --ink-soft: rgba(245, 243, 255, 0.82);
  --ink-muted: rgba(245, 243, 255, 0.6);
  --accent: #b8a4ff;
  --accent-strong: #9f87ff;
  --accent-soft: rgba(184, 164, 255, 0.22);
  --accent-contrast: #160f24;
  --success: #34d399;
  --success-soft: rgba(52, 211, 153, 0.22);
  --danger: #f87171;
  --danger-soft: rgba(248, 113, 113, 0.22);
  --shadow-lg: 0 32px 70px rgba(10, 6, 18, 0.6);
  --shadow-md: 0 22px 50px rgba(10, 6, 18, 0.48);
  --shadow-sm: 0 14px 32px rgba(10, 6, 18, 0.38);
}

*,
*::before,
*::after {
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  background: radial-gradient(circle at top left, var(--bg-alt), transparent 55%),
    linear-gradient(180deg, var(--bg) 0%, var(--surface) 60%, var(--bg-alt) 100%);
  color: var(--ink);
  font-family: 'Plus Jakarta Sans', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
}

body::before {
  content: "";
  position: fixed;
  inset: 0;
  pointer-events: none;
  background-image: radial-gradient(rgba(124, 58, 237, 0.12) 1px, transparent 1px);
  background-size: 28px 28px;
  opacity: 0.35;
}

[hidden] {
  display: none !important;
}

a {
  color: inherit;
  text-decoration: none;
  transition: color var(--transition), opacity var(--transition);
}

a:hover,
a:focus-visible {
  color: var(--accent-strong);
}

a:focus-visible,
button:focus-visible {
  outline: 3px solid var(--accent);
  outline-offset: 3px;
}

button {
  font: inherit;
  color: inherit;
  background: none;
  border: none;
  cursor: pointer;
}

/* Layout */
.app-shell {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* Header */
.site-header {
  position: sticky;
  top: 0;
  z-index: 30;
  backdrop-filter: blur(18px);
  background: color-mix(in srgb, var(--surface-soft) 88%, transparent);
  border-bottom: 1px solid var(--stroke);
}

.header-shell {
  width: var(--content-width);
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.85rem;
  padding: 0.75rem 0;
  min-height: var(--header-height);
}

/* Brand */
.brand {
  display: inline-flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.55rem 0.85rem 0.55rem 0.55rem;
  border-radius: var(--radius-md);
  border: 1px solid var(--stroke);
  background: var(--surface);
  box-shadow: var(--shadow-sm);
  transition: transform var(--transition), box-shadow var(--transition);
}

.brand:hover {
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

.brand-icon {
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 999px;
  background: linear-gradient(140deg, var(--accent), var(--accent-strong));
  color: var(--accent-contrast);
  display: grid;
  place-items: center;
  font-family: 'Playfair Display', 'Times New Roman', serif;
  font-size: 1.1rem;
  letter-spacing: 0.04em;
}

.brand-copy {
  display: flex;
  flex-direction: column;
  gap: 0.1rem;
}

.brand-title {
  font-family: 'Playfair Display', 'Times New Roman', serif;
  font-size: 1.2rem;
  letter-spacing: 0.02em;
}

.brand-subtitle {
  font-size: 0.82rem;
  color: var(--ink-muted);
}

/* Header Actions */
.header-actions {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

/* Theme Toggle */
.theme-icon {
  width: 1.25rem;
  height: 1.25rem;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, var(--accent-contrast) 0%, var(--accent-contrast) 34%, transparent 60%),
    linear-gradient(140deg, var(--accent), var(--accent-strong));
  box-shadow: inset 0 -2px 4px rgba(0, 0, 0, 0.16);
}

[data-theme="dark"] .theme-icon {
  background: radial-gradient(circle at 70% 30%, rgba(22, 14, 33, 0.35) 0%, rgba(22, 14, 33, 0.35) 34%, transparent 58%),
    linear-gradient(140deg, var(--accent), var(--accent-strong));
  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.25);
}

.theme-toggle {
  width: 2.75rem;
  height: 2.75rem;
  border-radius: 999px;
  border: 1px solid var(--stroke);
  background: var(--surface);
  display: grid;
  place-items: center;
  transition: transform var(--transition), box-shadow var(--transition);
  box-shadow: var(--shadow-sm);
}

.theme-toggle:hover {
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.45rem;
  padding: 0.6rem 1.2rem;
  border-radius: 999px;
  font-weight: 600;
  border: 1px solid transparent;
  transition: transform var(--transition), box-shadow var(--transition), background var(--transition), color var(--transition);
  background: linear-gradient(140deg, var(--accent), var(--accent-strong));
  color: var(--accent-contrast);
  box-shadow: var(--shadow-sm);
}

.btn:hover,
.btn:focus-visible {
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

.btn.ghost {
  background: transparent;
  color: var(--accent-strong);
  border-color: color-mix(in srgb, var(--accent) 35%, transparent);
}

.btn.ghost:hover,
.btn.ghost:focus-visible {
  background: var(--accent-soft);
}

.btn.danger {
  background: linear-gradient(140deg, var(--danger), #dc2626);
  color: white;
}

.btn.small {
  padding: 0.4rem 0.8rem;
  font-size: 0.85rem;
}

/* Main Content */
main {
  flex: 1;
  padding: 2rem 0;
}

.page-shell {
  width: var(--content-width);
  margin: 0 auto;
}

/* Page Header */
.page-header {
  text-align: center;
  margin-bottom: 2rem;
}

.page-title {
  font-family: 'Playfair Display', 'Times New Roman', serif;
  font-size: clamp(1.8rem, 5vw, 2.5rem);
  margin: 0 0 0.5rem;
}

.page-subtitle {
  color: var(--ink-soft);
  font-size: 1rem;
  margin: 0;
}

/* Calendar Container */
.calendar-container {
  background: var(--surface);
  border: 1px solid var(--stroke);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  overflow: hidden;
}

/* Calendar Header */
.calendar-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem 1.5rem;
  background: var(--surface-muted);
  border-bottom: 1px solid var(--stroke);
}

.calendar-nav {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.calendar-nav-btn {
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 999px;
  border: 1px solid var(--stroke);
  background: var(--surface);
  display: grid;
  place-items: center;
  font-size: 1.2rem;
  transition: all var(--transition);
}

.calendar-nav-btn:hover {
  background: var(--accent-soft);
  color: var(--accent-strong);
}

.calendar-month-year {
  font-family: 'Playfair Display', 'Times New Roman', serif;
  font-size: 1.5rem;
  font-weight: 600;
}

/* Calendar Grid */
.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
}

.calendar-day-header {
  padding: 0.75rem 0.5rem;
  text-align: center;
  font-weight: 700;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--ink-muted);
  background: var(--surface-muted);
  border-bottom: 1px solid var(--stroke);
}

.calendar-day {
  min-height: 80px;
  padding: 0.5rem;
  border-right: 1px solid var(--stroke);
  border-bottom: 1px solid var(--stroke);
  cursor: pointer;
  transition: background var(--transition);
  position: relative;
}

.calendar-day:nth-child(7n) {
  border-right: none;
}

.calendar-day:hover:not(.past):not(.empty) {
  background: var(--accent-soft);
}

.calendar-day.empty {
  background: var(--surface-muted);
  cursor: default;
}

.calendar-day.past {
  background: var(--danger-soft);
  cursor: not-allowed;
  opacity: 0.6;
}

.calendar-day.today {
  background: var(--accent-soft);
}

.calendar-day.today .day-number {
  background: var(--accent);
  color: var(--accent-contrast);
  border-radius: 999px;
  width: 1.75rem;
  height: 1.75rem;
  display: grid;
  place-items: center;
}

.calendar-day.signed-up {
  background: var(--success-soft);
}

.day-number {
  font-weight: 600;
  font-size: 0.9rem;
  margin-bottom: 0.25rem;
}

.day-signup {
  font-size: 0.7rem;
  color: var(--ink-soft);
  line-height: 1.3;
  word-break: break-word;
}

.day-signup.taken {
  color: var(--success);
  font-weight: 600;
}

/* Legend */
.calendar-legend {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  padding: 1rem 1.5rem;
  background: var(--surface-muted);
  border-top: 1px solid var(--stroke);
  font-size: 0.85rem;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.legend-color {
  width: 1rem;
  height: 1rem;
  border-radius: 4px;
  border: 1px solid var(--stroke);
}

.legend-color.available {
  background: var(--surface);
}

.legend-color.today {
  background: var(--accent-soft);
}

.legend-color.signed-up {
  background: var(--success-soft);
}

.legend-color.past {
  background: var(--danger-soft);
}

/* Modal */
.modal {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(16, 10, 27, 0.48);
  backdrop-filter: blur(12px);
  padding: 1rem;
  z-index: 100;
}

.modal-card {
  width: min(420px, 92vw);
  background: var(--surface);
  border-radius: var(--radius-lg);
  border: 1px solid var(--stroke-strong);
  box-shadow: var(--shadow-lg);
  padding: 1.5rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.modal-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 0.8rem;
}

.modal-title {
  margin: 0;
  font-family: 'Playfair Display', 'Times New Roman', serif;
  font-size: 1.5rem;
}

.modal-close {
  width: 2.25rem;
  height: 2.25rem;
  border-radius: 999px;
  border: 1px solid var(--stroke);
  background: var(--surface-muted);
  position: relative;
  flex-shrink: 0;
}

.modal-close::before,
.modal-close::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 12px;
  height: 2px;
  background: var(--ink);
  transform-origin: center;
}

.modal-close::before {
  transform: translate(-50%, -50%) rotate(45deg);
}

.modal-close::after {
  transform: translate(-50%, -50%) rotate(-45deg);
}

.modal-body {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.modal-date {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--accent-strong);
}

/* Form */
.form-group {
  display: flex;
  flex-direction: column;
  gap: 0.35rem;
}

.form-label {
  font-weight: 600;
  font-size: 0.85rem;
}

.form-input {
  padding: 0.75rem 1rem;
  border: 1px solid var(--stroke-strong);
  border-radius: var(--radius-sm);
  background: var(--surface);
  color: var(--ink);
  font: inherit;
  transition: border-color var(--transition), box-shadow var(--transition);
}

.form-input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-soft);
}

.form-input::placeholder {
  color: var(--ink-muted);
}

.form-hint {
  font-size: 0.75rem;
  color: var(--ink-muted);
}

.form-actions {
  display: flex;
  gap: 0.75rem;
  margin-top: 0.5rem;
}

.form-actions .btn {
  flex: 1;
}

/* Current Signup Display */
.current-signup {
  padding: 1rem;
  background: var(--success-soft);
  border-radius: var(--radius-sm);
  border: 1px solid var(--success);
}

.current-signup-label {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--ink-muted);
  margin-bottom: 0.25rem;
}

.current-signup-name {
  font-weight: 600;
  font-size: 1.1rem;
}

.current-signup-phone {
  font-size: 0.9rem;
  color: var(--ink-soft);
}

/* Footer */
.site-footer {
  margin-top: auto;
  padding: 2rem 1.5rem;
  text-align: center;
  color: var(--ink-muted);
  font-size: 0.85rem;
}

/* Loading State */
.loading {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 3rem;
  color: var(--ink-muted);
}

.loading::after {
  content: '';
  width: 1.5rem;
  height: 1.5rem;
  margin-left: 0.75rem;
  border: 2px solid var(--stroke);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

/* Responsive */
@media (max-width: 600px) {
  .calendar-day {
    min-height: 60px;
    padding: 0.35rem;
  }

  .day-number {
    font-size: 0.8rem;
  }

  .day-signup {
    font-size: 0.6rem;
  }

  .calendar-month-year {
    font-size: 1.1rem;
  }

  .calendar-header {
    padding: 0.75rem 1rem;
  }

  .calendar-legend {
    padding: 0.75rem 1rem;
    gap: 0.75rem;
    font-size: 0.75rem;
  }
}
</style>
</head>
<body>
<div class="app-shell">
<header class="site-header">
  <div class="header-shell">
    <a class="brand" href="/">
      <span class="brand-icon" aria-hidden="true">SW</span>
      <span class="brand-copy">
        <span class="brand-title">Salt Wash Ward</span>
        <span class="brand-subtitle">Missionary Dinners</span>
      </span>
    </a>
    <div class="header-actions">
      <a class="btn ghost" href="/">Back to Home</a>
      <button class="theme-toggle" id="theme-toggle" type="button" aria-label="Switch theme">
        <span class="theme-icon" aria-hidden="true"></span>
      </button>
    </div>
  </div>
</header>

<main>
  <div class="page-shell">
    <div class="page-header">
      <h1 class="page-title">Missionary Dinner Calendar</h1>
      <p class="page-subtitle">Click on an available date to sign up to feed the missionaries</p>
    </div>

    <div class="calendar-container">
      <div class="calendar-header">
        <button class="calendar-nav-btn" id="prev-month" aria-label="Previous month">&larr;</button>
        <h2 class="calendar-month-year" id="month-year"></h2>
        <button class="calendar-nav-btn" id="next-month" aria-label="Next month">&rarr;</button>
      </div>
      <div class="calendar-grid" id="calendar-grid">
        <div class="loading">Loading calendar...</div>
      </div>
      <div class="calendar-legend">
        <div class="legend-item">
          <span class="legend-color available"></span>
          <span>Available</span>
        </div>
        <div class="legend-item">
          <span class="legend-color today"></span>
          <span>Today</span>
        </div>
        <div class="legend-item">
          <span class="legend-color signed-up"></span>
          <span>Signed Up</span>
        </div>
        <div class="legend-item">
          <span class="legend-color past"></span>
          <span>Past</span>
        </div>
      </div>
    </div>
  </div>
</main>

<footer class="site-footer">
  <p>Not an official site of The Church of Jesus Christ of Latter-day Saints. Intended for local Salt Wash Ward use only.</p>
</footer>
</div>

<!-- Signup Modal -->
<div class="modal" id="signup-modal" hidden>
  <div class="modal-card">
    <div class="modal-header">
      <h2 class="modal-title" id="modal-title">Sign Up for Dinner</h2>
      <button class="modal-close" id="modal-close" type="button" aria-label="Close"></button>
    </div>
    <div class="modal-body" id="modal-body">
      <p class="modal-date" id="modal-date"></p>

      <!-- Empty slot form -->
      <form id="signup-form">
        <div class="form-group">
          <label class="form-label" for="first-name">First Name</label>
          <input class="form-input" type="text" id="first-name" required placeholder="Enter first name">
        </div>
        <div class="form-group">
          <label class="form-label" for="last-name">Last Name</label>
          <input class="form-input" type="text" id="last-name" required placeholder="Enter last name">
        </div>
        <div class="form-group">
          <label class="form-label" for="phone">Phone Number</label>
          <input class="form-input" type="tel" id="phone" required placeholder="123-456-7890" pattern="[0-9]{3}-[0-9]{3}-[0-9]{4}">
          <span class="form-hint">Format: 123-456-7890</span>
        </div>
        <div class="form-actions">
          <button type="button" class="btn ghost" id="cancel-btn">Cancel</button>
          <button type="submit" class="btn">Sign Up</button>
        </div>
      </form>

      <!-- Existing signup display -->
      <div id="existing-signup" hidden>
        <div class="current-signup">
          <div class="current-signup-label">Currently signed up</div>
          <div class="current-signup-name" id="existing-name"></div>
          <div class="current-signup-phone" id="existing-phone"></div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn ghost" id="close-btn">Close</button>
          <button type="button" class="btn danger" id="clear-btn">Remove Signup</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
// ===========================================
// FIREBASE CONFIGURATION
// ===========================================
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
import { getDatabase, ref, onValue, set, remove, child } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBYkgD6v0mAFfCDEm_X1lbPR7kh3H27ukg",
  authDomain: "salt-wash-ward-missionary.firebaseapp.com",
  databaseURL: "https://salt-wash-ward-missionary-default-rtdb.firebaseio.com",
  projectId: "salt-wash-ward-missionary",
  storageBucket: "salt-wash-ward-missionary.firebasestorage.app",
  messagingSenderId: "655176347538",
  appId: "1:655176347538:web:fe919cb904eba9eb151b4b"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const signupsRef = ref(db, 'missionary-dinners');

// ===========================================
// STATE
// ===========================================
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth();
let selectedDate = null;
let signups = {};

// ===========================================
// DOM ELEMENTS
// ===========================================
const calendarGrid = document.getElementById('calendar-grid');
const monthYearDisplay = document.getElementById('month-year');
const prevMonthBtn = document.getElementById('prev-month');
const nextMonthBtn = document.getElementById('next-month');
const modal = document.getElementById('signup-modal');
const modalTitle = document.getElementById('modal-title');
const modalDate = document.getElementById('modal-date');
const signupForm = document.getElementById('signup-form');
const existingSignup = document.getElementById('existing-signup');
const existingName = document.getElementById('existing-name');
const existingPhone = document.getElementById('existing-phone');
const modalClose = document.getElementById('modal-close');
const cancelBtn = document.getElementById('cancel-btn');
const closeBtn = document.getElementById('close-btn');
const clearBtn = document.getElementById('clear-btn');
const themeToggle = document.getElementById('theme-toggle');

// ===========================================
// THEME
// ===========================================
function applyTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  themeToggle.setAttribute('aria-label', `Switch to ${theme === 'dark' ? 'light' : 'dark'} theme`);
}

function initTheme() {
  const stored = localStorage.getItem('theme');
  const prefersLight = window.matchMedia('(prefers-color-scheme: light)').matches;
  const initial = stored || (prefersLight ? 'light' : 'dark');
  applyTheme(initial);

  themeToggle.addEventListener('click', () => {
    const current = document.documentElement.getAttribute('data-theme');
    const next = current === 'light' ? 'dark' : 'light';
    applyTheme(next);
    localStorage.setItem('theme', next);
  });
}

// ===========================================
// UTILITIES
// ===========================================
function formatDateKey(year, month, day) {
  return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
}

function formatDisplayDate(dateKey) {
  const [year, month, day] = dateKey.split('-').map(Number);
  const date = new Date(year, month - 1, day);
  return date.toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

function isToday(year, month, day) {
  const today = new Date();
  return today.getFullYear() === year &&
         today.getMonth() === month &&
         today.getDate() === day;
}

function isPast(year, month, day) {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const date = new Date(year, month, day);
  // Consider dates as past if they're more than 25 hours ago
  const cutoff = new Date(today);
  cutoff.setHours(-1);
  return date < cutoff;
}

function formatPhoneNumber(input) {
  const cleaned = input.replace(/\D/g, '');
  if (cleaned.length >= 10) {
    return `${cleaned.slice(0, 3)}-${cleaned.slice(3, 6)}-${cleaned.slice(6, 10)}`;
  }
  return input;
}

function escapeHtml(text) {
  if (!text) return '';
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// ===========================================
// CALENDAR RENDERING
// ===========================================
function renderCalendar() {
  const firstDay = new Date(currentYear, currentMonth, 1).getDay();
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

  const monthNames = [
    'January', 'February', 'March', 'April', 'May', 'June',
    'July', 'August', 'September', 'October', 'November', 'December'
  ];

  monthYearDisplay.textContent = `${monthNames[currentMonth]} ${currentYear}`;

  let html = '';

  // Day headers
  const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  dayNames.forEach(day => {
    html += `<div class="calendar-day-header">${day}</div>`;
  });

  // Empty cells before first day
  for (let i = 0; i < firstDay; i++) {
    html += '<div class="calendar-day empty"></div>';
  }

  // Day cells
  for (let day = 1; day <= daysInMonth; day++) {
    const dateKey = formatDateKey(currentYear, currentMonth, day);
    const signup = signups[dateKey];
    const today = isToday(currentYear, currentMonth, day);
    const past = isPast(currentYear, currentMonth, day);

    let classes = 'calendar-day';
    if (today) classes += ' today';
    if (past) classes += ' past';
    if (signup) classes += ' signed-up';

    let signupDisplay = '';
    if (signup) {
      const initial = signup.firstName.charAt(0).toUpperCase();
      const lastName = signup.lastName;
      signupDisplay = `<div class="day-signup taken">${escapeHtml(initial)}. ${escapeHtml(lastName)}</div>`;
    }

    html += `
      <div class="${classes}" data-date="${dateKey}" ${past ? '' : 'tabindex="0"'}>
        <div class="day-number">${day}</div>
        ${signupDisplay}
      </div>
    `;
  }

  calendarGrid.innerHTML = html;

  // Add click handlers
  document.querySelectorAll('.calendar-day:not(.empty):not(.past)').forEach(cell => {
    cell.addEventListener('click', () => openModal(cell.dataset.date));
    cell.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        openModal(cell.dataset.date);
      }
    });
  });
}

// ===========================================
// MODAL
// ===========================================
function openModal(dateKey) {
  selectedDate = dateKey;
  const signup = signups[dateKey];

  modalDate.textContent = formatDisplayDate(dateKey);

  if (signup) {
    modalTitle.textContent = 'Dinner Signup';
    existingName.textContent = `${signup.firstName} ${signup.lastName}`;
    existingPhone.textContent = signup.phone;
    signupForm.hidden = true;
    existingSignup.hidden = false;
  } else {
    modalTitle.textContent = 'Sign Up for Dinner';
    signupForm.reset();
    signupForm.hidden = false;
    existingSignup.hidden = true;
  }

  modal.hidden = false;
  document.body.style.overflow = 'hidden';

  if (!signup) {
    document.getElementById('first-name').focus();
  }
}

function closeModal() {
  modal.hidden = true;
  document.body.style.overflow = '';
  selectedDate = null;
  signupForm.reset();
}

// ===========================================
// FIREBASE OPERATIONS
// ===========================================
function saveSignup(dateKey, data) {
  return set(child(signupsRef, dateKey), data);
}

function removeSignup(dateKey) {
  return remove(child(signupsRef, dateKey));
}

function cleanupOldSignups() {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const cutoff = new Date(today);
  cutoff.setDate(cutoff.getDate() - 1);
  cutoff.setHours(-1);

  Object.keys(signups).forEach(dateKey => {
    const [year, month, day] = dateKey.split('-').map(Number);
    const date = new Date(year, month - 1, day);
    if (date < cutoff) {
      removeSignup(dateKey);
    }
  });
}

// ===========================================
// EVENT LISTENERS
// ===========================================
prevMonthBtn.addEventListener('click', () => {
  currentMonth--;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  }
  renderCalendar();
});

nextMonthBtn.addEventListener('click', () => {
  currentMonth++;
  if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  renderCalendar();
});

modalClose.addEventListener('click', closeModal);
cancelBtn.addEventListener('click', closeModal);
closeBtn.addEventListener('click', closeModal);

modal.addEventListener('click', (e) => {
  if (e.target === modal) closeModal();
});

window.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeModal();
});

// Phone number formatting
document.getElementById('phone').addEventListener('input', (e) => {
  e.target.value = formatPhoneNumber(e.target.value);
});

// Form submission
signupForm.addEventListener('submit', async (e) => {
  e.preventDefault();

  const firstName = document.getElementById('first-name').value.trim();
  const lastName = document.getElementById('last-name').value.trim();
  const phone = document.getElementById('phone').value.trim();

  if (!firstName || !lastName || !phone) {
    alert('Please fill in all fields.');
    return;
  }

  try {
    await saveSignup(selectedDate, {
      firstName,
      lastName,
      phone,
      timestamp: Date.now()
    });
    closeModal();
  } catch (error) {
    console.error('Error saving signup:', error);
    alert('There was an error saving your signup. Please try again.');
  }
});

// Clear signup
clearBtn.addEventListener('click', async () => {
  if (!confirm('Are you sure you want to remove this signup?')) return;

  try {
    await removeSignup(selectedDate);
    closeModal();
  } catch (error) {
    console.error('Error removing signup:', error);
    alert('There was an error removing the signup. Please try again.');
  }
});

// ===========================================
// INITIALIZATION
// ===========================================
function init() {
  initTheme();

  // Listen for realtime updates from Firebase
  onValue(signupsRef, (snapshot) => {
    signups = snapshot.val() || {};
    renderCalendar();
    cleanupOldSignups();
  });
}

init();
</script>
</body>
</html>
